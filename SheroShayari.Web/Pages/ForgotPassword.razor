@page "/forgot-password"
@using SheroShayari.Web.Services
@using MudBlazor
@inject IAuthService AuthService
@inject ISnackbar Snackbar
@inject NavigationManager Navigation

<PageTitle>Forgot Password</PageTitle>

<MudContainer MaxWidth="MaxWidth.Small" Class="py-8">
    <MudPaper Elevation="2" Class="auth-card pa-6">
        <MudStack Spacing="3">
            <MudText Typo="Typo.h4" Class="text-center">Forgot Password?</MudText>
            <MudText Typo="Typo.body2" Class="text-center">
                Enter your email address and we'll send you a link to reset your password.
            </MudText>

            <MudForm @ref="form" @bind-IsValid="@isFormValid">
                <!-- Email Input -->
                <MudTextField 
                    @bind-Value="email"
                    Label="Email Address"
                    Placeholder="Enter your email"
                    FullWidth="true"
                    Variant="Variant.Outlined"
                    InputType="InputType.Email"
                    Required="true"
                    RequiredError="Email is required"
                    Disabled="isLoading"
                    Class="mb-4" />

                <!-- Submit Button -->
                <MudButton 
                    Variant="Variant.Filled"
                    Color="Color.Primary"
                    Size="Size.Large"
                    FullWidth="true"
                    OnClick="HandleForgotPassword"
                    Disabled="isLoading || !isFormValid">
                    @if (isLoading)
                    {
                        <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                    }
                    Send Recovery Link
                </MudButton>
            </MudForm>

            <!-- Back to Login Link -->
            <MudDivider />
            <MudStack Row="true" Spacing="1" Justify="Justify.Center">
                <MudText Typo="Typo.body2">Remember your password?</MudText>
                <MudLink Href="/login">Back to Login</MudLink>
            </MudStack>
        </MudStack>
    </MudPaper>
</MudContainer>

@code {
    private MudForm? form;
    private string? email;
    private bool isLoading = false;
    private bool isFormValid = false;

    private async Task HandleForgotPassword()
    {
        if (form != null)
        {
            await form.Validate();
            if (!isFormValid)
            {
                Snackbar.Add("Please enter a valid email address.", Severity.Warning);
                return;
            }
        }

        if (string.IsNullOrWhiteSpace(email))
        {
            Snackbar.Add("Email is required.", Severity.Warning);
            return;
        }

        isLoading = true;

        try
        {
            var (success, message) = await AuthService.ForgotPasswordAsync(email);

            if (success)
            {
                Snackbar.Add("Password recovery link sent! Check your email.", Severity.Success);
                email = null;
                if (form != null)
                {
                    await form.ResetAsync();
                }
                await Task.Delay(2000);
                Navigation.NavigateTo("/login");
            }
            else
            {
                Snackbar.Add(message ?? "Failed to send recovery link. Please try again.", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
        finally
        {
            isLoading = false;
        }
    }
}

<style>
    .auth-card {
        background: rgba(26, 26, 26, 0.8);
        border: 1px solid rgba(212, 175, 55, 0.2);
        border-radius: 8px;
    }
</style>
